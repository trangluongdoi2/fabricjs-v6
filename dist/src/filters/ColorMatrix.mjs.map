{"version":3,"file":"ColorMatrix.mjs","sources":["../../../src/filters/ColorMatrix.ts"],"sourcesContent":["import type { TClassProperties } from '../typedefs';\nimport { BaseFilter } from './BaseFilter';\nimport type { T2DPipelineState, TWebGLUniformLocationMap } from './typedefs';\nimport { classRegistry } from '../ClassRegistry';\nimport { fragmentSource } from './shaders/colorMatrix';\nexport const colorMatrixDefaultValues: Partial<TClassProperties<ColorMatrix>> =\n  {\n    matrix: [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0],\n    mainParameter: 'matrix',\n    colorsOnly: true,\n  };\n\n/**\n   * Color Matrix filter class\n   * @see {@link http://fabricjs.com/image-filters|ImageFilters demo}\n   * @see {@Link http://phoboslab.org/log/2013/11/fast-image-filters-with-webgl demo}\n   * @example <caption>Kodachrome filter</caption>\n   * const filter = new ColorMatrix({\n   *  matrix: [\n       1.1285582396593525, -0.3967382283601348, -0.03992559172921793, 0, 63.72958762196502,\n       -0.16404339962244616, 1.0835251566291304, -0.05498805115633132, 0, 24.732407896706203,\n       -0.16786010706155763, -0.5603416277695248, 1.6014850761964943, 0, 35.62982807460946,\n       0, 0, 0, 1, 0\n      ]\n   * });\n   * object.filters.push(filter);\n   * object.applyFilters();\n   */\nexport class ColorMatrix extends BaseFilter {\n  /**\n   * Colormatrix for pixels.\n   * array of 20 floats. Numbers in positions 4, 9, 14, 19 loose meaning\n   * outside the -1, 1 range.\n   * 0.0039215686 is the part of 1 that get translated to 1 in 2d\n   * @param {Array} matrix array of 20 numbers.\n   * @default\n   */\n  declare matrix: number[];\n\n  /**\n   * Lock the colormatrix on the color part, skipping alpha, mainly for non webgl scenario\n   * to save some calculation\n   * @type Boolean\n   * @default true\n   */\n  declare colorsOnly: boolean;\n\n  static type = 'ColorMatrix';\n\n  static defaults = colorMatrixDefaultValues;\n\n  setOptions({ matrix, ...options }: Record<string, any>) {\n    if (matrix) {\n      // safeguard against mutation\n      this.matrix = [...matrix];\n    }\n    Object.assign(this, options);\n  }\n\n  getFragmentSource(): string {\n    return fragmentSource;\n  }\n\n  /**\n   * Apply the ColorMatrix operation to a Uint8Array representing the pixels of an image.\n   *\n   * @param {Object} options\n   * @param {ImageData} options.imageData The Uint8Array to be filtered.\n   */\n  applyTo2d(options: T2DPipelineState) {\n    const imageData = options.imageData,\n      data = imageData.data,\n      m = this.matrix,\n      colorsOnly = this.colorsOnly;\n\n    for (let i = 0; i < data.length; i += 4) {\n      const r = data[i];\n      const g = data[i + 1];\n      const b = data[i + 2];\n      if (colorsOnly) {\n        data[i] = r * m[0] + g * m[1] + b * m[2] + m[4] * 255;\n        data[i + 1] = r * m[5] + g * m[6] + b * m[7] + m[9] * 255;\n        data[i + 2] = r * m[10] + g * m[11] + b * m[12] + m[14] * 255;\n      } else {\n        const a = data[i + 3];\n        data[i] = r * m[0] + g * m[1] + b * m[2] + a * m[3] + m[4] * 255;\n        data[i + 1] = r * m[5] + g * m[6] + b * m[7] + a * m[8] + m[9] * 255;\n        data[i + 2] =\n          r * m[10] + g * m[11] + b * m[12] + a * m[13] + m[14] * 255;\n        data[i + 3] =\n          r * m[15] + g * m[16] + b * m[17] + a * m[18] + m[19] * 255;\n      }\n    }\n  }\n\n  /**\n   * Return WebGL uniform locations for this filter's shader.\n   *\n   * @param {WebGLRenderingContext} gl The GL canvas context used to compile this filter's shader.\n   * @param {WebGLShaderProgram} program This filter's compiled shader program.\n   */\n  getUniformLocations(\n    gl: WebGLRenderingContext,\n    program: WebGLProgram\n  ): TWebGLUniformLocationMap {\n    return {\n      uColorMatrix: gl.getUniformLocation(program, 'uColorMatrix'),\n      uConstants: gl.getUniformLocation(program, 'uConstants'),\n    };\n  }\n\n  /**\n   * Send data from this filter to its shader program's uniforms.\n   *\n   * @param {WebGLRenderingContext} gl The GL canvas context used to compile this filter's shader.\n   * @param {Object} uniformLocations A map of string uniform names to WebGLUniformLocation objects\n   */\n  sendUniformData(\n    gl: WebGLRenderingContext,\n    uniformLocations: TWebGLUniformLocationMap\n  ) {\n    const m = this.matrix,\n      matrix = [\n        m[0],\n        m[1],\n        m[2],\n        m[3],\n        m[5],\n        m[6],\n        m[7],\n        m[8],\n        m[10],\n        m[11],\n        m[12],\n        m[13],\n        m[15],\n        m[16],\n        m[17],\n        m[18],\n      ],\n      constants = [m[4], m[9], m[14], m[19]];\n    gl.uniformMatrix4fv(uniformLocations.uColorMatrix, false, matrix);\n    gl.uniform4fv(uniformLocations.uConstants, constants);\n  }\n}\n\nclassRegistry.setClass(ColorMatrix);\n"],"names":["colorMatrixDefaultValues","matrix","mainParameter","colorsOnly","ColorMatrix","BaseFilter","setOptions","_ref","options","_objectWithoutProperties","_excluded","Object","assign","getFragmentSource","fragmentSource","applyTo2d","imageData","data","m","i","length","r","g","b","a","getUniformLocations","gl","program","uColorMatrix","getUniformLocation","uConstants","sendUniformData","uniformLocations","constants","uniformMatrix4fv","uniform4fv","_defineProperty","classRegistry","setClass"],"mappings":"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"}